# core/views.py

# core/views.py

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib import messages
from django.conf import settings
from django.contrib.auth import get_user_model
from django.utils.dateparse import parse_date
from django.contrib.auth.forms import PasswordChangeForm
from django.contrib.auth import update_session_auth_hash

from .forms import WorkZoneForm, AdminZoneCreationForm, CustomLoginForm
from .models import WorkZone

Usuario = get_user_model()

# ============================ Helpers ============================

def is_admingl(user):
    return user.is_authenticated and user.user_type == 'admin_global'

def is_admin_zone(user):
    return user.is_authenticated and user.user_type == 'admin_zone'

def redirect_user_based_on_role(user):
    if user.user_type == 'operador':
        if user.workzone and user.workzone.nombre.lower() == 'hospital':
            return redirect('InicioOperadorHospital')
        elif user.workzone and user.workzone.nombre.lower() == 'clinica':
            return redirect('InicioOperadorClinica')
    elif user.user_type == 'admin_zone':
        if user.workzone and user.workzone.nombre.lower() == 'hospital':
            return redirect('InicioAdminHospital')
        elif user.workzone and user.workzone.nombre.lower() == 'clinica':
            return redirect('InicioAdminClinica')
    elif user.user_type == 'admin_global':
        return redirect('InicioAdminGl')
    return redirect('Ingreso')

# ============================ Autenticación ============================

def home(request):
    if request.user.is_authenticated:
        return redirect_user_based_on_role(request.user)
    return render(request, 'core/home.html')

def Ingreso(request):
    if request.method == 'POST':
        form = CustomLoginForm(request, data=request.POST)
        if form.is_valid():
            user = form.get_user()
            login(request, user)
            return redirect_user_based_on_role(user)
        else:
            messages.error(request, 'Usuario o contraseña incorrectos.')
    else:
        form = CustomLoginForm()
    return render(request, 'core/Ingreso.html', {'form': form})

@login_required
def logout_view(request):
    logout(request)
    return redirect('Ingreso')

# ============================ Vistas Operador ============================

@login_required
def InicioOperadorHospital(request):
    if request.user.user_type != 'operador' or request.user.workzone.nombre.lower() != 'hospital':
        return redirect('Ingreso')
    return render(request, 'core/Operador/InicioOperadorHospital.html')

@login_required
def InicioOperadorClinica(request):
    if request.user.user_type != 'operador' or request.user.workzone.nombre.lower() != 'clinica':
        return redirect('Ingreso')
    return render(request, 'core/Operador/InicioOperadorClinica.html')

@login_required
def cambiar_contrasena(request):
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            messages.success(request, 'Contraseña actualizada correctamente!')
            return redirect_user_based_on_role(request.user)
        else:
            messages.error(request, 'Por favor corrija los errores.')
    else:
        form = PasswordChangeForm(request.user)
    return render(request, 'core/Operador/cambiar_contrasena.html', {'form': form})

# ============================ Vistas Admin por Zona ============================

@login_required
def InicioAdminHospital(request):
    if not is_admin_zone(request.user) or request.user.workzone.nombre.lower() != 'hospital':
        return redirect('Ingreso')
    return render(request, 'core/Admin/InicioAdminHospital.html')

@login_required
def InicioAdminClinica(request):
    if not is_admin_zone(request.user) or request.user.workzone.nombre.lower() != 'clinica':
        return redirect('Ingreso')
    return render(request, 'core/Admin/InicioAdminClinica.html')

@login_required
def HospitalGestionUsuarios(request):
    if not is_admin_zone(request.user) or request.user.workzone.nombre.lower() != 'hospital':
        return redirect('Ingreso')

    if request.method == 'POST':
        if 'delete_user' in request.POST:
            user_id = request.POST.get('delete_user')
            user = get_object_or_404(Usuario, id=user_id, user_type='operador', workzone=request.user.workzone)
            user.delete()
            messages.success(request, f"Operador '{user.username}' eliminado correctamente.")
            return redirect('HospitalGestionUsuarios')

        username = request.POST.get('username')
        first_name = request.POST.get('first_name')
        last_name = request.POST.get('last_name')
        date_of_entry = request.POST.get('date_of_entry')
        password = '12345678'

        if not username:
            messages.error(request, "El nombre de usuario es requerido.")
        elif Usuario.objects.filter(username=username).exists():
            messages.error(request, "El nombre de usuario ya existe.")
        else:
            user = Usuario.objects.create_user(
                username=username,
                first_name=first_name,
                last_name=last_name,
                password=password,
                user_type='operador',
                workzone=request.user.workzone
            )
            user.date_of_entry = parse_date(date_of_entry) if date_of_entry else None
            user.save()
            messages.success(request, f"Operador '{username}' creado exitosamente con contraseña por defecto.")
            return redirect('HospitalGestionUsuarios')

    operadores = Usuario.objects.filter(user_type='operador', workzone=request.user.workzone)
    return render(request, 'core/Admin/HospitalGestionUsuarios.html', {'operadores': operadores})

# ============================ Vistas Admin Global ============================

@login_required
@user_passes_test(is_admingl)
def InicioAdminGl(request):
    return render(request, 'core/AdminGL/InicioAdminGl.html')

@login_required
@user_passes_test(is_admingl)
def crear_workzone(request):
    if request.method == 'POST':
        form = WorkZoneForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Zona de trabajo creada exitosamente.")
            return redirect('listar_workzones')
    else:
        form = WorkZoneForm()
    return render(request, 'core/AdminGL/crear_workzone.html', {'form': form})

@login_required
@user_passes_test(is_admingl)
def crear_admin_zone(request):
    if request.method == 'POST':
        form = AdminZoneCreationForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Administrador de zona creado exitosamente.")
            return redirect('crear_admin_zone')
    else:
        form = AdminZoneCreationForm()
    return render(request, 'core/AdminGL/crear_admin_zone.html', {'form': form})

@login_required
@user_passes_test(is_admingl)
def listar_workzones(request):
    zonas = WorkZone.objects.all()
    return render(request, 'core/AdminGL/listar_workzones.html', {'zonas': zonas})


# core/urls.py

# core/urls.py
from django.urls import path
from . import views

urlpatterns = [
    # Public views
    path('', views.home, name='home'),
    path('Ingreso/', views.Ingreso, name='Ingreso'),
    path('logout/', views.logout_view, name='logout'),

    # Operador views
    path('InicioOperadorHospital/', views.InicioOperadorHospital, name='InicioOperadorHospital'),
    path('InicioOperadorClinica/', views.InicioOperadorClinica, name='InicioOperadorClinica'),
    path('cambiar_contrasena/', views.cambiar_contrasena, name='cambiar_contrasena'),

    # Admin Zona views
    path('InicioAdminHospital/', views.InicioAdminHospital, name='InicioAdminHospital'),
    path('InicioAdminClinica/', views.InicioAdminClinica, name='InicioAdminClinica'),
    path('HospitalGestionUsuarios/', views.HospitalGestionUsuarios, name='HospitalGestionUsuarios'),

    # Admin Global views
    path('InicioAdminGl/', views.InicioAdminGl, name='InicioAdminGl'),
    path('admin_global/workzones/crear/', views.crear_workzone, name='crear_workzone'),
    path('admin_global/workzones/listar/', views.listar_workzones, name='listar_workzones'),
    path('admin_global/admins/crear/', views.crear_admin_zone, name='crear_admin_zone'),
]


# core/models.py


# core/models.py
from django.db import models
from django.contrib.auth.models import AbstractUser

class WorkZone(models.Model):
    nombre = models.CharField(max_length=100)
    numero = models.CharField(max_length=50)
    correo = models.EmailField()
    direccion = models.TextField()

    def __str__(self):
        return self.nombre

class Evento(models.Model):
    workzone = models.ForeignKey(WorkZone, on_delete=models.CASCADE, related_name='eventos')
    tipo = models.CharField(max_length=100)
    nombre = models.CharField(max_length=100)
    problema = models.TextField()
    solucion = models.TextField()
    fecha = models.DateTimeField(auto_now_add=True) 

    def __str__(self):
        return f"{self.tipo} - {self.nombre}"
    

class CustomUser(AbstractUser):
    USER_TYPE_CHOICES = (
        ('admin_global', 'Administrador Global'),
        ('admin_zone', 'Administrador Zona'),
        ('operator', 'Operador'),
    )
    user_type = models.CharField(max_length=20, choices=USER_TYPE_CHOICES, default='operator')
    workzone = models.ForeignKey('WorkZone', null=True, blank=True, on_delete=models.SET_NULL)
    date_of_entry = models.DateField(null=True, blank=True)



# core/admin.py

from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import CustomUser, WorkZone, Evento

@admin.register(CustomUser)
class CustomUserAdmin(UserAdmin):
    model = CustomUser
    list_display = ('username', 'user_type', 'email', 'workzone')
    fieldsets = UserAdmin.fieldsets + (
        ('Rol y Zona', {'fields': ('user_type', 'workzone')}),
    )
    add_fieldsets = UserAdmin.add_fieldsets + (
        ('Rol y Zona', {'fields': ('user_type', 'workzone')}),
    )

@admin.register(WorkZone)
class WorkZoneAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'numero', 'correo', 'direccion')

@admin.register(Evento)
class EventoAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'tipo', 'workzone', 'fecha')
    list_filter = ('tipo', 'workzone')




### Templates de Administrador_zona

# core/templates/core/Admin/AgregarUsuario.html

{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2>Añadir nuevo operador</h2>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Crear Usuario</button>
</form>
</div>
{% endblock %}


# core/templates/core/Admin/HospitalGestionUsuarios.html

{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Gestionar Operadores - Hospital</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">Crear nuevo operador</div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="id_username" class="form-label">Nombre de usuario</label>
                    <input type="text" name="username" class="form-control" id="id_username" required>
                </div>
                <div class="mb-3">
                    <label for="id_first_name" class="form-label">Nombre</label>
                    <input type="text" name="first_name" class="form-control" id="id_first_name">
                </div>
                <div class="mb-3">
                    <label for="id_last_name" class="form-label">Apellido</label>
                    <input type="text" name="last_name" class="form-control" id="id_last_name">
                </div>
                <div class="mb-3">
                    <label for="id_date_of_entry" class="form-label">Fecha de ingreso</label>
                    <input type="date" name="date_of_entry" class="form-control" id="id_date_of_entry">
                </div>
                <div class="alert alert-info">
                    <small>La contraseña por defecto será "12345678"</small>
                </div>
                <button type="submit" class="btn btn-primary">Crear operador</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Lista de operadores (Hospital)</div>
        <ul class="list-group list-group-flush">
            {% for op in operadores %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ op.username }}</strong> - {{ op.first_name }} {{ op.last_name }}
                        {% if op.date_of_entry %} <small class="text-muted">(Ingreso: {{ op.date_of_entry }})</small>{% endif %}
                    </div>
                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="delete_user" value="{{ op.id }}">
                        <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                    </form>
                </li>
            {% empty %}
                <li class="list-group-item">No hay operadores registrados para el hospital.</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}


# core/templates/core/Admin/InicioAdminHospital.html


{% extends 'core/base.html' %}
{% load static %}

{% block content %}

<div>
    <h1>Inicio Admin</h1>
</div>
{% endblock %}


### Templates de Administrador_Global

# core/templates/core/AdminGL/crear_admin_zone

{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2>Crear Administrador de Zona</h2>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-success">Crear</button>
  </form>
</div>
{% endblock %}


# core/templates/core/AdminGL/crear_workzone

{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-5">
  <h2>Crear WorkZone</h2>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary">Guardar</button>
  </form>
</div>
{% endblock %}


# core/templates/core/AdminGL/InicioAdminGl

{% extends 'core/base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Panel de Administración Global</h2>
    <p>Desde aquí puedes gestionar zonas de trabajo y administradores.</p>
    <div class="d-grid gap-2 mt-4">
        <a href="{% url 'crear_workzone' %}" class="btn btn-primary">Crear Zona de Trabajo</a>
        <a href="{% url 'crear_admin_zone' %}" class="btn btn-success">Crear Administrador de Zona</a>
    </div>
</div>
{% endblock %}


### Templates de Operador

# core/templates/core/Operador/cambiar_contrasena

{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Cambiar Contraseña</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {% for field in form %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger">
                                {% for error in field.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                <a href="{% url 'InicioOperadorHospital' %}" class="btn btn-secondary">Cancelar</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}
# core/templates/core/Operador/InicioOperadorHospital

{% extends 'core/base.html' %}
{% load static %}

{% block content %}

<div>
    <h1>Inicio Operador HHHHHHHHHHHH</h1>
</div>
{% endblock %}

# core/templates/core/Operador/InicioOperadorOficina

{% extends 'core/base.html' %}
{% load static %}

{% block content %}

<div>
    <h1>Inicio Operador OOOOOOOOOOOOOOOOOO</h1>
</div>
{% endblock %}



### Templates de usuario no logeado 

# core/templates/core/base.html

{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ nombre_tienda|default:"SP_VI Sistema" }}</title>

    <link rel="shortcut icon" href="{% static 'core/images/favicon.png' %}" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="{% static 'core/css/style.css' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    {% block stylesheet %}{% endblock %}
</head>

<body>

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark bg-gradient-midnight shadow">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">
            <img src="{% static 'core/images/logo.png' %}" alt="Logo" height="40" class="d-inline-block align-top">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarMain">
            <ul class="navbar-nav me-auto">

                <!-- INICIO: dinámica según usuario -->
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        {% if user.user_type == 'admin_global' %}
                            <a class="nav-link" href="{% url 'InicioAdminGl' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% elif user.user_type == 'admin_zone' and user.workzone.nombre|lower == 'hospital' %}
                            <a class="nav-link" href="{% url 'InicioAdminHospital' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% elif user.user_type == 'admin_zone' and user.workzone.nombre|lower == 'clinica' %}
                            <a class="nav-link" href="{% url 'InicioAdminClinica' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% elif user.user_type == 'operador' and user.workzone.nombre|lower == 'hospital' %}
                            <a class="nav-link" href="{% url 'InicioOperadorHospital' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% elif user.user_type == 'operador' and user.workzone.nombre|lower == 'clinica' %}
                            <a class="nav-link" href="{% url 'InicioOperadorClinica' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% else %}
                            <a class="nav-link" href="{% url 'home' %}">
                                <i class="bi bi-house-fill"></i> Inicio
                            </a>
                        {% endif %}
                    </li>

                    <!-- Menú por rol -->
                    {% if user.user_type == 'admin_global' %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-globe"></i> Admin Global
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'InicioAdminGl' %}">Dashboard</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'crear_workzone' %}">Crear Zona</a></li>
                                <li><a class="dropdown-item" href="{% url 'crear_admin_zone' %}">Crear Administrador</a></li>
                                <li><a class="dropdown-item" href="{% url 'listar_workzones' %}">Ver Zonas</a></li>
                            </ul>
                        </li>
                    {% elif user.user_type == 'admin_zone' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'HospitalGestionUsuarios' %}">
                                <i class="bi bi-people-fill"></i> Gestionar Operadores
                            </a>
                        </li>
                    {% elif user.user_type == 'operador' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'cambiar_contrasena' %}">
                                <i class="bi bi-key"></i> Cambiar Contraseña
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <!-- Usuario no autenticado -->
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">
                            <i class="bi bi-house-door-fill"></i> Inicio
                        </a>
                    </li>
                {% endif %}
            </ul>

            <!-- Usuario y logout -->
            <ul class="navbar-nav ms-auto">
                {% if user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text">
                                <small class="text-muted">Rol: {{ user.get_user_type_display }}</small>
                            </span></li>
                            {% if user.workzone %}
                                <li><span class="dropdown-item-text">
                                    <small class="text-muted">Zona: {{ user.workzone.nombre }}</small>
                                </span></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'cambiar_contrasena' %}">
                                <i class="bi bi-key-fill"></i> Cambiar contraseña
                            </a></li>
                            <li>
                                <form method="POST" action="{% url 'logout' %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'Ingreso' %}">
                            <i class="bi bi-box-arrow-in-right"></i> Ingresar
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>
{% endblock navbar %}

{% block content %}
{% endblock content %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% block script %}{% endblock %}
</body>
</html>


# core/templates/core/home.html

{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<!-- No <head> or <body> inside blocks, let base.html handle that -->

<!-- Top Image -->
<div class="top-image-container">
    <img src="{% static 'core/images/fondo.jpg' %}" alt="">
</div>

<!-- Title Below the Image -->
<div class="contenedor-titulo-inicio">
  <h1>KYVM Ingenieria Limitada</h1>
</div>

<!-- Main Content -->
<div class="container mt-5">
  <h2>Somos una empresa formada por dos ingenieros civiles informáticos con más de 25 años
    de experiencia en creación, desarrollo, implementación y gestión de soluciones
    informáticas, tanto en el sector público como privado.</h2>
</div>



{% endblock content %}


# core/templates/core/Ingreso.html

{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6 p-0">
      <img src="{% static 'core/images/fondo.jpg' %}" alt="Left Side Image" class="img-half">
    </div>
    
    <div class="col-md-6 d-flex align-items-center justify-content-center">
      <div class="text-center">
        <h2>Ingreso</h2>

        <form method="POST">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div class="mb-3">
              {{ form.username.label_tag }}
              {{ form.username }}
              {{ form.username.errors }}
          </div>
          <div class="mb-3">
              {{ form.password.label_tag }}
              {{ form.password }}
              {{ form.password.errors }}
          </div>
          <button type="submit" class="btn btn-primary">Ingresar</button>
      </form>
      
      {% if messages %}
          {% for message in messages %}
              <div class="alert alert-warning">{{ message }}</div>
          {% endfor %}
      {% endif %}

      
       
      </div>
    </div>
  </div>
</div>
{% endblock %}





