{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Inventario de Cajas</h2>

    <!-- Formulario para agregar nuevas cajas -->
    <form method="post" class="card p-3 mb-4">
        {% csrf_token %}
        <h5><i class="bi bi-plus-square"></i> Agregar nueva caja</h5>
        {{ add_box_form.as_p }}
        <button type="submit" name="add_box" class="btn btn-primary">Agregar Caja</button>
    </form>

    <!-- Formulario para registrar entrega (sin JavaScript) -->
    <form method="post" class="card p-3 mb-4">
        {% csrf_token %}
        <h5><i class="bi bi-box-arrow-up"></i> Registrar Entrega</h5>

        <div class="mb-3">
            {{ delivery_form.modelo.label_tag }}
            {{ delivery_form.modelo }}
        </div>

        {% if delivery_form.fields.numero_unico.choices %}
        <div class="mb-3">
            {{ delivery_form.numero_unico.label_tag }}
            {{ delivery_form.numero_unico }}
        </div>

        <div class="mb-3">
            {{ delivery_form.area_destino.label_tag }}
            {{ delivery_form.area_destino }}
        </div>

        <div class="mb-3">
            {{ delivery_form.hora_entrega.label_tag }}
            {{ delivery_form.hora_entrega }}
        </div>

        <button type="submit" name="register_delivery" class="btn btn-warning">Registrar Entrega</button>
        {% else %}
        <button type="submit" name="filtrar_modelo" class="btn btn-secondary">Filtrar modelo</button>
        {% endif %}
    </form>

    <!-- Tablas separadas por modelo -->
    <h4>Cajas disponibles</h4>
    {% for grupo in tabla_por_modelo %}
        <h5>Modelo: {{ grupo.modelo }} (Total: {{ grupo.total }})</h5>
        <table class="table table-striped table-bordered mb-4">
            <thead>
                <tr>
                    <th>Número único</th>
                </tr>
            </thead>
            <tbody>
                {% if grupo.numeros %}
                    {% for numero in grupo.numeros %}
                        <tr><td>{{ numero }}</td></tr>
                    {% endfor %}
                {% else %}
                    <tr><td class="text-muted">No hay cajas disponibles</td></tr>
                {% endif %}
            </tbody>
        </table>
    {% empty %}
        <p>No hay modelos disponibles.</p>
    {% endfor %}

    <!-- Botón \"Sin cambios\" -->
    <form method="post" class="mb-4">
        {% csrf_token %}
        <button type="submit" name="sin_cambios" class="btn btn-outline-secondary">
            <i class="bi bi-check2-circle"></i> Registrar \"Sin cambios\"
        </button>
    </form>

    <!-- Historial del día actual -->
    <h4>Historial de entregas de hoy</h4>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>MODELO</th>
                <th>NÚMERO</th>
                <th>ÁREA DESTINO</th>
                <th>HORA</th>
                <th>USUARIO</th>
            </tr>
        </thead>
        <tbody>
            {% for r in historial %}
            <tr>
                <td>{% if not r.sin_cambios %}{{ r.caja.modelo.nombre }}{% else %}—{% endif %}</td>
                <td>{% if not r.sin_cambios %}{{ r.caja.numero_unico }}{% else %}—{% endif %}</td>
                <td>{% if not r.sin_cambios %}{{ r.area_destino }}{% else %}SIN CAMBIOS{% endif %}</td>
                <td>  {{ r.fecha_hora|date:'h:i A' }} </td>
                <td>{{ r.usuario.username }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center text-muted">No hay registros hoy.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block script %}
<script> new DataTable('#tablaInventario'); </script>
{% endblock %}
